# Recuperar Contrase√±a v√≠a WhatsApp

## Resumen

Sistema de "olvid√© mi contrase√±a" que env√≠a un c√≥digo de verificaci√≥n al WhatsApp del usuario. Resuelve el problema de que todos los usuarios tienen `password` como contrase√±a por defecto.

## Flujo del Usuario

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        PANTALLA DE LOGIN                            ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ   [üì± +51 940393758        ]                                        ‚îÇ
‚îÇ   [üîí ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢          üëÅ ]                                        ‚îÇ
‚îÇ   [      Ingresar          ]                                        ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ         ¬øOlvidaste tu contrase√±a?  ‚Üê Link nuevo                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   PASO 1: SOLICITAR C√ìDIGO                          ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ   Ingresa tu n√∫mero de tel√©fono registrado                          ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ   [üì± +51 940393758        ]                                        ‚îÇ
‚îÇ   [   Enviar c√≥digo        ]                                        ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ   ‚Üê Volver al login                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº POST /auth/forgot-password
                              ‚îÇ ‚Üí Genera c√≥digo 6 d√≠gitos
                              ‚îÇ ‚Üí Guarda en Redis (5 min TTL)
                              ‚îÇ ‚Üí Env√≠a template WhatsApp
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   PASO 2: VERIFICAR C√ìDIGO                          ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ   Ingresa el c√≥digo de 6 d√≠gitos enviado a tu WhatsApp              ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ   [ 1 ][ 2 ][ 3 ][ 4 ][ 5 ][ 6 ]  ‚Üê Input tipo OTP                  ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ   ¬øNo recibiste el c√≥digo? Reenviar (disponible en 60s)             ‚îÇ
‚îÇ   [   Verificar c√≥digo     ]                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº POST /auth/verify-reset-code
                              ‚îÇ ‚Üí Valida c√≥digo en Redis
                              ‚îÇ ‚Üí Retorna resetToken (JWT corto, 10 min)
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   PASO 3: NUEVA CONTRASE√ëA                          ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ   Crea tu nueva contrase√±a                                          ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ   [üîí Nueva contrase√±a     ]                                        ‚îÇ
‚îÇ   [üîí Confirmar contrase√±a ]                                        ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ   [   Cambiar contrase√±a   ]                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº POST /auth/reset-password
                              ‚îÇ ‚Üí Valida resetToken
                              ‚îÇ ‚Üí Actualiza passwordHash
                              ‚îÇ ‚Üí debeCambiarPassword = false
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   ‚úÖ √âXITO                                          ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ   Tu contrase√±a ha sido actualizada                                 ‚îÇ
‚îÇ   [   Ir al login          ]                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Template de WhatsApp (Meta Business Suite)

### Problema con Autenticaci√≥n

Los templates de categor√≠a "Autenticaci√≥n" requieren:
- Cuenta verificada con historial de mensajes de calidad
- Permisos especiales que se desbloquean con el uso

### Soluci√≥n: Usar categor√≠a "Utilidad"

Meta detecta palabras como "c√≥digo", "verificaci√≥n", "clave", "ingresar" y las marca como autenticaci√≥n. Usar un texto que suene a **notificaci√≥n de servicio**:

**Nombre del template:** `solicitud_referencia`

**Categor√≠a:** Utilidad

**Idioma:** Spanish (Peru) - `es_PE`

**Cuerpo (opciones que evitan detecci√≥n):**

```
Hola de Covima. Tu solicitud fue procesada con el n√∫mero: {{1}}. Guarda este n√∫mero para referencia.
```

o

```
Covima: Hemos recibido tu solicitud. Tu n√∫mero de referencia es: {{1}}. Gracias por contactarnos.
```

**Variable de muestra:** `123456`

**Pie de p√°gina:** (vac√≠o o "V√°lido por 5 minutos")

**Botones:** Ninguno

### Importante

- Evitar palabras: c√≥digo, verificaci√≥n, clave, contrase√±a, ingresar, acceso, OTP
- El mensaje debe sonar a "notificaci√≥n" no a "autenticaci√≥n"

---

## Implementaci√≥n Backend

### 1. Nuevos DTOs

**Archivo:** `backend/src/auth/dto/forgot-password.dto.ts`

```typescript
import { IsString, IsNotEmpty, MinLength } from 'class-validator';

export class ForgotPasswordDto {
  @IsString()
  @IsNotEmpty()
  codigoPais: string;

  @IsString()
  @IsNotEmpty()
  telefono: string;
}

export class VerifyResetCodeDto {
  @IsString()
  @IsNotEmpty()
  codigoPais: string;

  @IsString()
  @IsNotEmpty()
  telefono: string;

  @IsString()
  @IsNotEmpty()
  code: string;
}

export class ResetPasswordWithTokenDto {
  @IsString()
  @IsNotEmpty()
  resetToken: string;

  @IsString()
  @MinLength(6)
  newPassword: string;
}
```

### 2. Nuevos Endpoints

**Archivo:** `backend/src/auth/auth.controller.ts`

```typescript
// POST /auth/forgot-password
@Post('forgot-password')
@ApiOperation({ summary: 'Solicitar c√≥digo de recuperaci√≥n v√≠a WhatsApp' })
async forgotPassword(@Body() dto: ForgotPasswordDto) {
  return this.authService.forgotPassword(dto);
}

// POST /auth/verify-reset-code
@Post('verify-reset-code')
@ApiOperation({ summary: 'Verificar c√≥digo y obtener token de reset' })
async verifyResetCode(@Body() dto: VerifyResetCodeDto) {
  return this.authService.verifyResetCode(dto);
}

// POST /auth/reset-password
@Post('reset-password')
@ApiOperation({ summary: 'Establecer nueva contrase√±a con token' })
async resetPassword(@Body() dto: ResetPasswordWithTokenDto) {
  return this.authService.resetPasswordWithToken(dto);
}
```

### 3. L√≥gica en AuthService

**Archivo:** `backend/src/auth/auth.service.ts`

```typescript
import { WhatsappBotService } from '../whatsapp-bot/whatsapp-bot.service';

// Inyectar en constructor
constructor(
  private prisma: PrismaService,
  private jwtService: JwtService,
  private redisService: RedisService,
  private whatsappService: WhatsappBotService,  // Agregar
) {}

// Generar c√≥digo 6 d√≠gitos
private generateResetCode(): string {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

// POST /auth/forgot-password
async forgotPassword(dto: ForgotPasswordDto) {
  const { codigoPais, telefono } = dto;
  const redisKey = `reset:${codigoPais}:${telefono}`;
  const cooldownKey = `reset:cooldown:${codigoPais}:${telefono}`;
  const attemptsKey = `reset:attempts:${codigoPais}:${telefono}`;

  // Rate limiting: m√°ximo 3 solicitudes cada 15 min
  const attempts = await this.redisService.get(attemptsKey);
  if (attempts && parseInt(attempts) >= 3) {
    throw new BadRequestException('Demasiados intentos. Espera 15 minutos.');
  }

  // Cooldown: 60 segundos entre solicitudes
  const cooldown = await this.redisService.get(cooldownKey);
  if (cooldown) {
    throw new BadRequestException('Espera 60 segundos antes de solicitar otro c√≥digo.');
  }

  // Buscar usuario (no revelar si existe o no)
  const usuario = await this.prisma.usuario.findUnique({
    where: { codigoPais_telefono: { codigoPais, telefono } },
  });

  // Siempre responder igual (seguridad)
  if (!usuario || !usuario.activo) {
    return { message: 'Si el n√∫mero est√° registrado, recibir√°s un c√≥digo.' };
  }

  // Generar y guardar c√≥digo
  const code = this.generateResetCode();
  await this.redisService.set(redisKey, code, 300); // 5 min TTL
  await this.redisService.set(cooldownKey, '1', 60); // 60 seg cooldown
  await this.redisService.incr(attemptsKey);
  await this.redisService.expire(attemptsKey, 900); // 15 min TTL

  // Enviar WhatsApp
  const phoneNumber = `${codigoPais}${telefono}`;
  await this.whatsappService.sendTemplateToPhone(
    phoneNumber,
    'solicitud_referencia',  // Nombre del template
    'es_PE',
    [code],  // {{1}} = c√≥digo
  );

  return { message: 'Si el n√∫mero est√° registrado, recibir√°s un c√≥digo.' };
}

// POST /auth/verify-reset-code
async verifyResetCode(dto: VerifyResetCodeDto) {
  const { codigoPais, telefono, code } = dto;
  const redisKey = `reset:${codigoPais}:${telefono}`;
  const failedKey = `reset:failed:${codigoPais}:${telefono}`;

  // Verificar intentos fallidos (m√°ximo 5)
  const failed = await this.redisService.get(failedKey);
  if (failed && parseInt(failed) >= 5) {
    throw new BadRequestException('Demasiados intentos fallidos. Solicita un nuevo c√≥digo.');
  }

  // Obtener c√≥digo guardado
  const savedCode = await this.redisService.get(redisKey);
  if (!savedCode) {
    throw new BadRequestException('C√≥digo expirado o no existe.');
  }

  // Comparar
  if (savedCode !== code) {
    await this.redisService.incr(failedKey);
    await this.redisService.expire(failedKey, 900); // 15 min
    throw new BadRequestException('C√≥digo incorrecto.');
  }

  // C√≥digo correcto: eliminar de Redis
  await this.redisService.del(redisKey);
  await this.redisService.del(failedKey);

  // Buscar usuario
  const usuario = await this.prisma.usuario.findUnique({
    where: { codigoPais_telefono: { codigoPais, telefono } },
  });

  if (!usuario) {
    throw new BadRequestException('Usuario no encontrado.');
  }

  // Generar resetToken (JWT corto)
  const resetToken = this.jwtService.sign(
    { sub: usuario.id, type: 'reset' },
    { expiresIn: '10m' },
  );

  return { resetToken };
}

// POST /auth/reset-password
async resetPasswordWithToken(dto: ResetPasswordWithTokenDto) {
  const { resetToken, newPassword } = dto;

  // Validar token
  let payload: any;
  try {
    payload = this.jwtService.verify(resetToken);
  } catch {
    throw new BadRequestException('Token inv√°lido o expirado.');
  }

  if (payload.type !== 'reset') {
    throw new BadRequestException('Token inv√°lido.');
  }

  // Actualizar contrase√±a
  const hashedPassword = await bcrypt.hash(newPassword, 10);
  await this.prisma.usuario.update({
    where: { id: payload.sub },
    data: {
      passwordHash: hashedPassword,
      debeCambiarPassword: false,
    },
  });

  return { message: 'Contrase√±a actualizada correctamente.' };
}
```

### 4. Redis Keys

```
reset:51:940393758           ‚Üí "123456"    (TTL: 5 min) - C√≥digo
reset:cooldown:51:940393758  ‚Üí "1"         (TTL: 60 seg) - Evita spam
reset:attempts:51:940393758  ‚Üí "3"         (TTL: 15 min) - Rate limiting
reset:failed:51:940393758    ‚Üí "2"         (TTL: 15 min) - Intentos fallidos
```

### 5. Modificar AuthModule

**Archivo:** `backend/src/auth/auth.module.ts`

```typescript
import { WhatsappBotModule } from '../whatsapp-bot/whatsapp-bot.module';

@Module({
  imports: [
    // ... existentes
    WhatsappBotModule,  // Agregar
  ],
  // ...
})
```

---

## Implementaci√≥n Frontend

### 1. Nueva P√°gina

**Archivo:** `frontend/src/pages/ForgotPassword.tsx`

Componente con 3 pasos:
- **Step 1**: Formulario tel√©fono ‚Üí solicitar c√≥digo
- **Step 2**: Input OTP 6 d√≠gitos ‚Üí verificar c√≥digo
- **Step 3**: Formulario nueva contrase√±a ‚Üí reset

### 2. Nuevos Endpoints en API

**Archivo:** `frontend/src/services/api.ts`

```typescript
export const authApi = {
  // ... existentes

  forgotPassword: async (data: { codigoPais: string; telefono: string }) => {
    const response = await api.post('/auth/forgot-password', data);
    return response.data;
  },

  verifyResetCode: async (data: { codigoPais: string; telefono: string; code: string }) => {
    const response = await api.post<{ resetToken: string }>('/auth/verify-reset-code', data);
    return response.data;
  },

  resetPasswordWithToken: async (data: { resetToken: string; newPassword: string }) => {
    const response = await api.post('/auth/reset-password', data);
    return response.data;
  },
};
```

### 3. Link en Login

**Archivo:** `frontend/src/pages/Login.tsx`

```tsx
import { Link } from 'react-router-dom';

// Despu√©s del bot√≥n "Ingresar"
<p className="text-center mt-4">
  <Link to="/forgot-password" className="text-sm text-blue-600 hover:underline">
    ¬øOlvidaste tu contrase√±a?
  </Link>
</p>
```

### 4. Nueva Ruta

**Archivo:** `frontend/src/App.tsx`

```tsx
import ForgotPassword from './pages/ForgotPassword';

// En las rutas p√∫blicas
<Route path="/forgot-password" element={<ForgotPassword />} />
```

---

## Archivos a Crear/Modificar

### Backend
| Archivo | Acci√≥n |
|---------|--------|
| `backend/src/auth/dto/forgot-password.dto.ts` | Crear |
| `backend/src/auth/dto/index.ts` | Modificar (exportar nuevos DTOs) |
| `backend/src/auth/auth.controller.ts` | Modificar (3 endpoints) |
| `backend/src/auth/auth.service.ts` | Modificar (3 m√©todos) |
| `backend/src/auth/auth.module.ts` | Modificar (importar WhatsappBotModule) |

### Frontend
| Archivo | Acci√≥n |
|---------|--------|
| `frontend/src/pages/ForgotPassword.tsx` | Crear |
| `frontend/src/pages/Login.tsx` | Modificar (link) |
| `frontend/src/services/api.ts` | Modificar (3 endpoints) |
| `frontend/src/App.tsx` | Modificar (ruta) |

---

## Seguridad

1. **Rate Limiting**: M√°ximo 3 solicitudes por tel√©fono cada 15 minutos
2. **Cooldown**: 60 segundos entre reenv√≠os de c√≥digo
3. **Intentos**: M√°ximo 5 intentos de verificaci√≥n por c√≥digo
4. **Expiraci√≥n c√≥digo**: 5 minutos
5. **Expiraci√≥n resetToken**: 10 minutos
6. **No revelar si usuario existe**: Siempre responder "c√≥digo enviado"

---

## Verificaci√≥n

1. **Backend**:
   - Probar endpoints con Swagger/curl
   - Verificar que el template llega a WhatsApp
   - Verificar expiraci√≥n en Redis

2. **Frontend**:
   - Probar flujo completo desde login
   - Verificar validaciones de formulario
   - Probar reenv√≠o de c√≥digo
   - Probar con c√≥digo incorrecto

3. **Integraci√≥n**:
   - Usuario con contrase√±a "password" puede resetear
   - Despu√©s del reset puede hacer login con nueva contrase√±a
   - `debeCambiarPassword` queda en `false`

---

## Pendiente

- [ ] Crear template en Meta Business Suite (cuando se apruebe)
- [ ] Actualizar nombre del template en el c√≥digo si cambia
