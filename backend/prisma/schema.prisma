// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS INBOX/HANDOFF ====================

enum ModoConversacion {
  BOT       // Bot responde automáticamente
  HANDOFF   // Admin atendiendo
  PAUSADO   // En espera de asignación
}

enum DireccionMensaje {
  ENTRANTE  // Usuario → Sistema
  SALIENTE  // Sistema → Usuario
}

enum EstadoMensaje {
  PENDIENTE
  ENVIADO
  ENTREGADO
  LEIDO
  FALLIDO
}

enum ModoRespuestaHandoff {
  WEB       // Solo desde el Inbox web
  WHATSAPP  // Solo desde WhatsApp con >>
  AMBOS     // Puede usar cualquiera
}

model Rol {
  id          Int           @id @default(autoincrement())
  nombre      String        @unique @db.VarChar(50)
  descripcion String?
  createdAt   DateTime      @default(now()) @map("created_at")
  usuarios    UsuarioRol[]

  @@map("roles")
}

model Usuario {
  id                   Int              @id @default(autoincrement())
  codigoPais           String           @default("51") @map("codigo_pais") @db.VarChar(5) // 51 = Perú
  telefono             String           @db.VarChar(20) // Solo el número local (sin código de país)
  passwordHash         String           @map("password_hash") @db.VarChar(255)
  nombre               String           @db.VarChar(100)
  nombreWhatsapp       String?          @map("nombre_whatsapp") @db.VarChar(100)
  email                String?          @db.VarChar(100)
  fotoUrl              String?          @map("foto_url") @db.VarChar(500)
  fechaNacimiento      DateTime?        @map("fecha_nacimiento") @db.Date
  direccion            String?          @db.VarChar(200)
  tipoDocumento        String?          @map("tipo_documento") @db.VarChar(20) // DNI, CE, PASAPORTE
  numeroDocumento      String?          @map("numero_documento") @db.VarChar(30)
  tallaPolo            String?          @map("talla_polo") @db.VarChar(10) // XS, S, M, L, XL, XXL
  esBautizado          Boolean?         @map("es_bautizado")
  biografia            String?          @db.Text
  genero               String?          @db.VarChar(20) // 'M', 'F', etc.
  activo               Boolean          @default(true)
  debeCambiarPassword  Boolean          @default(true) @map("debe_cambiar_password")
  ultimoLogin          DateTime?        @map("ultimo_login")
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")

  // Índice único compuesto: código de país + teléfono
  @@unique([codigoPais, telefono])

  // === PREFERENCIAS INBOX/HANDOFF ===
  recibirNotificacionesWhatsApp  Boolean              @default(true) @map("recibir_notificaciones_whatsapp")
  notificarNuevasConversaciones  Boolean              @default(true) @map("notificar_nuevas_conversaciones")
  modoHandoffDefault             ModoRespuestaHandoff @default(WEB) @map("modo_handoff_default")

  roles                UsuarioRol[]
  usuarioPartes        UsuarioParte[]
  programasCreados     Programa[]       @relation("ProgramaCreador")
  asignaciones         ProgramaAsignacion[]
  asistencias          Asistencia[]
  asistenciasConfirmadas Asistencia[]   @relation("ConfirmadorAsistencia")
  conversaciones       Conversacion[]
  notificaciones       Notificacion[]
  qrsCreados           QRAsistencia[]
  linksAgregados       ProgramaLink[]
  rolesAsignados       UsuarioRol[]     @relation("AsignadoPor")

  // === RELACIONES INBOX/HANDOFF ===
  conversacionesDerivadas Conversacion[] @relation("ConversacionesDerivadas")
  mensajesEnviados        Mensaje[]      @relation("MensajesEnviados")

  // === RELACIÓN GAMIFICACIÓN ===
  gamificacion            UsuarioGamificacion?

  // === RELACIONES PERIODOS RANKING ===
  rankingsCreados         PeriodoRanking[] @relation("RankingCreador")
  rankingsCerrados        PeriodoRanking[] @relation("RankingCerrador")

  // === CONTROL DE PARTICIPACIÓN EN RANKINGS ===
  participaEnRanking      Boolean          @default(true) @map("participa_en_ranking") // false = nunca aparece en rankings
  esJA                    Boolean          @default(true) @map("es_ja") // true = miembro JA, aparece en ranking general

  // === RELACIONES GRUPOS RANKING ===
  gruposRanking           GrupoRankingMiembro[]
  gruposRankingCreados    GrupoRanking[]   @relation("GrupoRankingCreador")
  miembrosAgregados       GrupoRankingMiembro[] @relation("MiembroAgregadoPor")

  // === RELACIONES ESTUDIOS BÍBLICOS ===
  estudiantesBiblicos     EstudianteBiblico[] @relation("EstudiantesBiblicos")

  // === RELACIONES CALENDARIO ===
  actividadesCreadas      Actividad[] @relation("ActividadesCreadaPor")

  @@map("usuarios")
}

model UsuarioRol {
  id          Int      @id @default(autoincrement())
  usuarioId   Int      @map("usuario_id")
  rolId       Int      @map("rol_id")
  asignadoPor Int?     @map("asignado_por")
  createdAt   DateTime @default(now()) @map("created_at")

  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  rol         Rol      @relation(fields: [rolId], references: [id], onDelete: Cascade)
  asignador   Usuario? @relation("AsignadoPor", fields: [asignadoPor], references: [id])

  @@unique([usuarioId, rolId])
  @@map("usuarios_roles")
}

model Parte {
  id            Int         @id @default(autoincrement())
  nombre        String      @unique @db.VarChar(100)
  descripcion   String?
  orden         Int
  esFija        Boolean     @default(false) @map("es_fija")
  esObligatoria Boolean     @default(false) @map("es_obligatoria") // Siempre aparece en programas nuevos
  textoFijo     String?     @map("texto_fijo") @db.VarChar(100)
  activo        Boolean     @default(true)
  // Gamificación - puntos por participar en esta parte
  puntos        Int         @default(0) // Puntos por participar
  xp            Int         @default(0) // XP por participar
  createdAt     DateTime    @default(now()) @map("created_at")

  usuarioPartes UsuarioParte[]
  asignaciones  ProgramaAsignacion[]
  links         ProgramaLink[]
  programaPartes ProgramaParte[]
  plantillaPartes PlantillaParte[]

  @@map("partes")
}

model UsuarioParte {
  id                   Int       @id @default(autoincrement())
  usuarioId            Int       @map("usuario_id")
  parteId              Int       @map("parte_id")
  ultimaParticipacion  DateTime? @map("ultima_participacion") @db.Date
  totalParticipaciones Int       @default(0) @map("total_participaciones")
  createdAt            DateTime  @default(now()) @map("created_at")

  usuario              Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  parte                Parte     @relation(fields: [parteId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, parteId])
  @@map("usuarios_partes")
}

model Programa {
  id             Int         @id @default(autoincrement())
  codigo         String      @unique @db.VarChar(20) // Ej: MA-X3kP9m (iniciales titulo + nanoid)
  fecha          DateTime    @db.Date // Ya no es unique - permite múltiples programas por día
  horaInicio     DateTime?   @map("hora_inicio") @db.Time() // Opcional
  horaFin        DateTime?   @map("hora_fin") @db.Time() // Opcional
  titulo         String      @default("Programa Maranatha Adoración") @db.VarChar(200)
  estado         String      @default("borrador") @db.VarChar(20)
  textoGenerado  String?     @map("texto_generado")
  creadoPor      Int?        @map("creado_por")
  enviadoAt      DateTime?   @map("enviado_at")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  creador        Usuario?    @relation("ProgramaCreador", fields: [creadoPor], references: [id])
  partes         ProgramaParte[]
  asignaciones   ProgramaAsignacion[]
  links          ProgramaLink[]
  notificaciones Notificacion[]
  conversaciones Conversacion[]

  @@map("programas")
}

// Nueva tabla para almacenar las partes de cada programa con su orden
model ProgramaParte {
  id          Int      @id @default(autoincrement())
  programaId  Int      @map("programa_id")
  parteId     Int      @map("parte_id")
  orden       Int      // Orden de esta parte en este programa específico
  createdAt   DateTime @default(now()) @map("created_at")

  programa    Programa @relation(fields: [programaId], references: [id], onDelete: Cascade)
  parte       Parte    @relation(fields: [parteId], references: [id])

  @@unique([programaId, parteId])
  @@map("programa_partes")
}

model ProgramaAsignacion {
  id           Int       @id @default(autoincrement())
  programaId   Int       @map("programa_id")
  parteId      Int       @map("parte_id")
  usuarioId    Int?      @map("usuario_id")    // Opcional - null si es nombre libre
  nombreLibre  String?   @map("nombre_libre") @db.VarChar(100) // Nombre cuando no hay usuario registrado
  orden        Int       @default(1)
  notificado   Boolean   @default(false)
  notificadoAt DateTime? @map("notificado_at")
  confirmado   Boolean   @default(false)
  confirmadoAt DateTime? @map("confirmado_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  programa     Programa  @relation(fields: [programaId], references: [id], onDelete: Cascade)
  parte        Parte     @relation(fields: [parteId], references: [id])
  usuario      Usuario?  @relation(fields: [usuarioId], references: [id])

  @@map("programa_asignaciones")
}

model ProgramaLink {
  id          Int      @id @default(autoincrement())
  programaId  Int      @map("programa_id")
  parteId     Int      @map("parte_id")
  nombre      String   @db.VarChar(200)
  url         String
  orden       Int      @default(1)
  agregadoPor Int?     @map("agregado_por")
  createdAt   DateTime @default(now()) @map("created_at")

  programa    Programa @relation(fields: [programaId], references: [id], onDelete: Cascade)
  parte       Parte    @relation(fields: [parteId], references: [id])
  agregador   Usuario? @relation(fields: [agregadoPor], references: [id])

  @@map("programa_links")
}

// ==================== PLANTILLAS DE PROGRAMA ====================

model PlantillaPrograma {
  id          Int       @id @default(autoincrement())
  nombre      String    @db.VarChar(100) // "Programa JA Estándar", "Culto Divino"
  descripcion String?   @db.VarChar(255)
  activo      Boolean   @default(true)
  esDefault   Boolean   @default(false) @map("es_default") // Plantilla seleccionada por defecto
  orden       Int       @default(0) // Orden en el selector
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  partes      PlantillaParte[]

  @@map("plantillas_programa")
}

model PlantillaParte {
  id           Int      @id @default(autoincrement())
  plantillaId  Int      @map("plantilla_id")
  parteId      Int      @map("parte_id")
  orden        Int      // Orden de esta parte en la plantilla

  plantilla    PlantillaPrograma @relation(fields: [plantillaId], references: [id], onDelete: Cascade)
  parte        Parte             @relation(fields: [parteId], references: [id])

  @@unique([plantillaId, parteId])
  @@map("plantilla_partes")
}

model QRAsistencia {
  id              Int          @id @default(autoincrement())
  semanaInicio    DateTime     @map("semana_inicio") @db.Date
  codigo          String       @unique @db.VarChar(50)
  tipoId          Int?         @map("tipo_id")
  descripcion     String?      @db.VarChar(200)
  urlGenerada     String?      @map("url_generada")
  activo          Boolean      @default(true)
  horaInicio      DateTime     @default(dbgenerated("'09:00:00'::time")) @map("hora_inicio") @db.Time()
  horaFin         DateTime     @default(dbgenerated("'12:00:00'::time")) @map("hora_fin") @db.Time()
  margenTemprana  Int          @default(15) @map("margen_temprana") // Minutos antes de horaInicio = temprana
  margenTardia    Int          @default(30) @map("margen_tardia") // Minutos después de horaInicio = tardía
  createdBy       Int?         @map("created_by")
  createdAt       DateTime     @default(now()) @map("created_at")

  creador        Usuario?        @relation(fields: [createdBy], references: [id])
  tipoAsistencia TipoAsistencia? @relation(fields: [tipoId], references: [id])
  asistencias    Asistencia[]

  @@map("qr_asistencia")
}

model Asistencia {
  id                  Int           @id @default(autoincrement())
  usuarioId           Int?          @map("usuario_id")
  telefonoRegistro    String?       @map("telefono_registro") @db.VarChar(25)
  nombreRegistro      String?       @map("nombre_registro") @db.VarChar(100)
  tipoId              Int?          @map("tipo_id")
  fecha               DateTime      @db.Date
  semanaInicio        DateTime      @map("semana_inicio") @db.Date
  datosFormulario     Json?         @map("datos_formulario")
  metodoRegistro      String        @map("metodo_registro") @db.VarChar(20)  // 'qr_web', 'qr_bot', 'plataforma'
  estado              String        @default("pendiente_confirmacion") @db.VarChar(30)
  confirmadoPor       Int?          @map("confirmado_por")
  confirmadoAt        DateTime?     @map("confirmado_at")
  notasConfirmacion   String?       @map("notas_confirmacion")
  qrId                Int?          @map("qr_id")
  createdAt           DateTime      @default(now()) @map("created_at")

  usuario             Usuario?      @relation(fields: [usuarioId], references: [id])
  confirmador         Usuario?      @relation("ConfirmadorAsistencia", fields: [confirmadoPor], references: [id])
  qr                  QRAsistencia? @relation(fields: [qrId], references: [id])
  tipo                TipoAsistencia? @relation(fields: [tipoId], references: [id])

  @@unique([telefonoRegistro, qrId])
  @@map("asistencias")
}

// ==================== TIPOS DE ASISTENCIA ====================

model TipoAsistencia {
  id            Int       @id @default(autoincrement())
  nombre        String    @unique @db.VarChar(50) // 'escuela_sabatica', 'programa_ja', 'gp', etc.
  label         String    @db.VarChar(100) // 'Escuela Sabática', 'Programa JA', 'Grupo Pequeño'
  descripcion   String?   @db.VarChar(255)
  icono         String?   @db.VarChar(50) // Nombre del ícono (lucide)
  color         String?   @db.VarChar(20) // Color en hex
  soloPresencia Boolean   @default(false) @map("solo_presencia")
  activo        Boolean   @default(true)
  orden         Int       @default(0)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  campos       FormularioCampo[]
  qrs          QRAsistencia[]
  asistencias  Asistencia[]

  @@map("tipos_asistencia")
}

model FormularioCampo {
  id              Int       @id @default(autoincrement())
  tipoAsistenciaId Int      @map("tipo_asistencia_id")
  nombre          String    @db.VarChar(50) // 'dias_estudio', 'hizo_estudio_biblico', etc.
  label           String    @db.VarChar(100) // 'Días de estudio de lección'
  tipo            String    @db.VarChar(30) // 'number', 'checkbox', 'text', 'select', 'rating'
  requerido       Boolean   @default(false)
  orden           Int       @default(0)
  placeholder     String?   @db.VarChar(100)
  valorMinimo     Int?      @map("valor_minimo") // Para type=number
  valorMaximo     Int?      @map("valor_maximo") // Para type=number
  opciones        Json?     // Para type=select [{ value: '', label: '' }]
  activo          Boolean   @default(true)
  createdAt       DateTime  @default(now()) @map("created_at")

  tipoAsistencia  TipoAsistencia @relation(fields: [tipoAsistenciaId], references: [id], onDelete: Cascade)

  @@map("formulario_campos")
}

model Conversacion {
  id                Int               @id @default(autoincrement())
  usuarioId         Int?              @map("usuario_id")
  telefono          String            @unique @db.VarChar(20)
  estado            String            @default("inicio") @db.VarChar(50)
  contexto          Json              @default("{}")
  moduloActivo      String?           @map("modulo_activo") @db.VarChar(50)
  programaEnEdicion Int?              @map("programa_en_edicion")
  ultimoMensajeAt   DateTime          @default(now()) @map("ultimo_mensaje_at")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  // === CAMPOS PARA INBOX/HANDOFF ===
  modo              ModoConversacion      @default(BOT)
  derivadaAId       Int?                  @map("derivada_a_id")
  derivadaAt        DateTime?             @map("derivada_at")
  ultimoMensaje     String?               @map("ultimo_mensaje") @db.VarChar(500)
  mensajesNoLeidos  Int                   @default(0) @map("mensajes_no_leidos")
  modoRespuesta     ModoRespuestaHandoff? @map("modo_respuesta") // Override del default del admin

  usuario           Usuario?          @relation(fields: [usuarioId], references: [id])
  programa          Programa?         @relation(fields: [programaEnEdicion], references: [id])
  derivadaA         Usuario?          @relation("ConversacionesDerivadas", fields: [derivadaAId], references: [id])
  mensajes          Mensaje[]

  // Índices para performance del inbox
  @@index([modo, updatedAt(sort: Desc)])
  @@index([derivadaAId, modo])
  @@map("conversaciones")
}

model Mensaje {
  id             Int              @id @default(autoincrement())
  conversacionId Int              @map("conversacion_id")
  direccion      DireccionMensaje
  contenido      String           @db.Text
  tipo           String           @default("texto") @db.VarChar(20)
  metadata       Json             @default("{}")
  createdAt      DateTime         @default(now()) @map("created_at")

  // === CAMPOS PARA INBOX/HANDOFF ===
  enviadoPorId   Int?             @map("enviado_por_id")  // null = bot automático
  whatsappMsgId  String?          @unique @map("whatsapp_msg_id") @db.VarChar(100)
  estado         EstadoMensaje    @default(ENVIADO)
  leidoAt        DateTime?        @map("leido_at")

  conversacion   Conversacion     @relation(fields: [conversacionId], references: [id], onDelete: Cascade)
  enviadoPor     Usuario?         @relation("MensajesEnviados", fields: [enviadoPorId], references: [id])

  // Índice para paginación eficiente
  @@index([conversacionId, createdAt(sort: Desc)])
  @@map("mensajes")
}

model Notificacion {
  id           Int       @id @default(autoincrement())
  usuarioId    Int?      @map("usuario_id")
  telefono     String    @db.VarChar(20)
  tipo         String    @db.VarChar(50)
  mensaje      String
  programaId   Int?      @map("programa_id")
  estado       String    @default("pendiente") @db.VarChar(20)
  enviadoAt    DateTime? @map("enviado_at")
  errorMensaje String?   @map("error_mensaje")
  createdAt    DateTime  @default(now()) @map("created_at")

  usuario      Usuario?  @relation(fields: [usuarioId], references: [id])
  programa     Programa? @relation(fields: [programaId], references: [id])

  @@map("notificaciones")
}

model AuditLog {
  id              Int      @id @default(autoincrement())
  usuarioId       Int?     @map("usuario_id")
  accion          String   @db.VarChar(100)
  tablaAfectada   String?  @map("tabla_afectada") @db.VarChar(50)
  registroId      Int?     @map("registro_id")
  datosAnteriores Json?    @map("datos_anteriores")
  datosNuevos     Json?    @map("datos_nuevos")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("audit_log")
}

// ==================== GAMIFICACIÓN ====================

enum CategoriaAccion {
  ASISTENCIA
  PARTICIPACION
  EVENTO_ESPECIAL
  LOGRO
  BONUS
}

enum EstadoRanking {
  ACTIVO
  CERRADO
  PAUSADO
}

model NivelBiblico {
  id              Int       @id @default(autoincrement())
  numero          Int       @unique // 1-10
  nombre          String    @unique @db.VarChar(50) // Discipulo, Diacono, etc.
  descripcion     String?   @db.VarChar(255)
  xpRequerido     Int       @map("xp_requerido") // XP mínimo para alcanzar este nivel
  icono           String?   @db.VarChar(50) // Icono o emoji
  color           String?   @db.VarChar(20) // Color en hex
  activo          Boolean   @default(true)
  createdAt       DateTime  @default(now()) @map("created_at")

  usuariosEnNivel UsuarioGamificacion[]

  @@map("niveles_biblicos")
}

model UsuarioGamificacion {
  id                  Int       @id @default(autoincrement())
  usuarioId           Int       @unique @map("usuario_id")
  puntosTotal         Int       @default(0) @map("puntos_total")
  puntosTrimestre     Int       @default(0) @map("puntos_trimestre")
  xpTotal             Int       @default(0) @map("xp_total")
  nivelId             Int       @default(1) @map("nivel_id")
  rachaActual         Int       @default(0) @map("racha_actual") // Semanas consecutivas
  rachaMejor          Int       @default(0) @map("racha_mejor") // Mejor racha histórica
  ultimaSemanaAsistio DateTime? @map("ultima_semana_asistio") @db.Date
  asistenciasTotales  Int       @default(0) @map("asistencias_totales")
  participacionesTotales Int    @default(0) @map("participaciones_totales")
  ocultoEnGeneral     Boolean   @default(false) @map("oculto_en_general") // Para líderes que quieren ocultarse del ranking general
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  usuario             Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  nivel               NivelBiblico @relation(fields: [nivelId], references: [id])
  historialPuntos     HistorialPuntos[]
  insignias           UsuarioInsignia[]
  eventosRegistrados  EventoEspecialRegistro[]

  @@map("usuarios_gamificacion")
}

model ConfiguracionPuntaje {
  id          Int             @id @default(autoincrement())
  codigo      String          @unique @db.VarChar(50) // 'asistencia_temprana', 'tema_central', etc.
  categoria   CategoriaAccion
  nombre      String          @db.VarChar(100)
  descripcion String?         @db.VarChar(255)
  puntos      Int
  xp          Int             @default(0)
  activo      Boolean         @default(true)
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  historialPuntos HistorialPuntos[]

  @@map("configuracion_puntaje")
}

model HistorialPuntos {
  id                Int       @id @default(autoincrement())
  usuarioGamId      Int       @map("usuario_gam_id")
  configPuntajeId   Int?      @map("config_puntaje_id")
  periodoRankingId  Int?      @map("periodo_ranking_id") // Nuevo: período al que pertenece
  puntos            Int
  xp                Int       @default(0)
  descripcion       String?   @db.VarChar(255)
  fecha             DateTime  @db.Date
  trimestre         Int?      // Legacy: se eliminará después de migración
  anio              Int?      @map("anio") // Legacy: se eliminará después de migración
  referenciaId      Int?      @map("referencia_id")
  referenciaTipo    String?   @map("referencia_tipo") @db.VarChar(50)
  createdAt         DateTime  @default(now()) @map("created_at")

  usuarioGam        UsuarioGamificacion @relation(fields: [usuarioGamId], references: [id], onDelete: Cascade)
  configPuntaje     ConfiguracionPuntaje? @relation(fields: [configPuntajeId], references: [id])
  periodoRanking    PeriodoRanking? @relation(fields: [periodoRankingId], references: [id])

  @@index([usuarioGamId, periodoRankingId])
  @@index([fecha])
  @@map("historial_puntos")
}

model Insignia {
  id              Int       @id @default(autoincrement())
  codigo          String    @unique @db.VarChar(50) // 'madrugador', 'constante', etc.
  nombre          String    @db.VarChar(100)
  descripcion     String?   @db.VarChar(255)
  icono           String?   @db.VarChar(50)
  color           String?   @db.VarChar(20)
  condicionTipo   String    @map("condicion_tipo") @db.VarChar(50) // 'asistencias_tempranas', 'racha_semanas', etc.
  condicionValor  Int       @map("condicion_valor") // Valor numérico de la condición
  puntosBonus     Int       @default(0) @map("puntos_bonus")
  xpBonus         Int       @default(0) @map("xp_bonus")
  activo          Boolean   @default(true)
  createdAt       DateTime  @default(now()) @map("created_at")

  usuariosConInsignia UsuarioInsignia[]

  @@map("insignias")
}

model UsuarioInsignia {
  id              Int       @id @default(autoincrement())
  usuarioGamId    Int       @map("usuario_gam_id")
  insigniaId      Int       @map("insignia_id")
  desbloqueadaAt  DateTime  @default(now()) @map("desbloqueada_at")
  notificado      Boolean   @default(false)

  usuarioGam      UsuarioGamificacion @relation(fields: [usuarioGamId], references: [id], onDelete: Cascade)
  insignia        Insignia @relation(fields: [insigniaId], references: [id], onDelete: Cascade)

  @@unique([usuarioGamId, insigniaId])
  @@map("usuarios_insignias")
}

model EventoEspecialConfig {
  id              Int       @id @default(autoincrement())
  codigo          String    @unique @db.VarChar(50) // 'd13', 'reavivados', 'semana_oracion', etc.
  nombre          String    @db.VarChar(100)
  descripcion     String?   @db.VarChar(255)
  puntos          Int
  xp              Int       @default(0)
  icono           String?   @db.VarChar(50)
  color           String?   @db.VarChar(20)
  activo          Boolean   @default(true)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  registros       EventoEspecialRegistro[]

  @@map("eventos_especiales_config")
}

model EventoEspecialRegistro {
  id              Int       @id @default(autoincrement())
  usuarioGamId    Int       @map("usuario_gam_id")
  eventoConfigId  Int       @map("evento_config_id")
  fecha           DateTime  @db.Date
  notas           String?   @db.VarChar(255)
  registradoPorId Int?      @map("registrado_por_id")
  createdAt       DateTime  @default(now()) @map("created_at")

  usuarioGam      UsuarioGamificacion @relation(fields: [usuarioGamId], references: [id], onDelete: Cascade)
  eventoConfig    EventoEspecialConfig @relation(fields: [eventoConfigId], references: [id], onDelete: Cascade)

  @@unique([usuarioGamId, eventoConfigId, fecha])
  @@map("eventos_especiales_registro")
}

model PeriodoRanking {
  id              Int           @id @default(autoincrement())
  nombre          String        @db.VarChar(100) // "Ranking Q1 2026"
  descripcion     String?       @db.Text
  fechaInicio     DateTime      @map("fecha_inicio") @db.Date
  fechaFin        DateTime?     @map("fecha_fin") @db.Date // null = sin cierre automático
  estado          EstadoRanking @default(ACTIVO)

  // Auditoría
  creadoPorId     Int?          @map("creado_por_id")
  cerradoAt       DateTime?     @map("cerrado_at")
  cerradoPorId    Int?          @map("cerrado_por_id")

  // Resultados al cerrar (snapshot del top)
  resultadosJson  Json?         @map("resultados_json")

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relaciones
  historialPuntos HistorialPuntos[]
  creadoPor       Usuario?      @relation("RankingCreador", fields: [creadoPorId], references: [id])
  cerradoPor      Usuario?      @relation("RankingCerrador", fields: [cerradoPorId], references: [id])
  gruposRanking   GrupoRanking[]

  @@map("periodos_ranking")
}

// ==================== GRUPOS DE RANKING ====================

enum TipoGrupoRanking {
  SISTEMA         // Creados por el sistema, no eliminables (General, Líderes)
  PERSONALIZADO   // Creados por admin
}

enum CriterioMembresia {
  MANUAL          // Admin selecciona usuarios uno a uno
  TODOS_ACTIVOS   // Todos con participaEnRanking = true (excepto líderes/admin)
  ROL_LIDER       // Usuarios con rol 'lider'
  ROL_ADMIN       // Usuarios con rol 'admin'
  ROL_LIDER_ADMIN // Usuarios con rol 'lider' o 'admin'
}

model GrupoRanking {
  id              Int                 @id @default(autoincrement())
  codigo          String              @unique @db.VarChar(50) // 'general', 'lideres', 'equipo_musica'
  nombre          String              @db.VarChar(100)
  descripcion     String?             @db.Text
  icono           String?             @db.VarChar(10)   // Emoji
  color           String?             @db.VarChar(20)   // Hex color

  // Tipo y criterio de membresía
  tipo            TipoGrupoRanking    @default(PERSONALIZADO)
  criterio        CriterioMembresia   @default(MANUAL)

  // Configuración de visibilidad
  esPublico       Boolean             @default(true) @map("es_publico")    // Aparece en lista de rankings
  soloMiembros    Boolean             @default(false) @map("solo_miembros") // Solo miembros pueden ver el ranking

  // Vinculación a período (opcional)
  periodoId       Int?                @map("periodo_id") // null = usa período activo

  // Orden en UI
  orden           Int                 @default(0)

  // Estado
  activo          Boolean             @default(true)

  // Auditoría
  creadoPorId     Int?                @map("creado_por_id")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relaciones
  miembros        GrupoRankingMiembro[]
  periodo         PeriodoRanking?     @relation(fields: [periodoId], references: [id])
  creadoPor       Usuario?            @relation("GrupoRankingCreador", fields: [creadoPorId], references: [id])

  @@map("grupos_ranking")
}

model GrupoRankingMiembro {
  id              Int       @id @default(autoincrement())
  grupoId         Int       @map("grupo_id")
  usuarioId       Int       @map("usuario_id")

  // Control individual de visibilidad
  oculto          Boolean   @default(false)   // Usuario puede ocultarse de este grupo

  // Auditoría
  agregadoPorId   Int?      @map("agregado_por_id")
  agregadoAt      DateTime  @default(now()) @map("agregado_at")

  // Relaciones
  grupo           GrupoRanking @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  usuario         Usuario      @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  agregadoPor     Usuario?     @relation("MiembroAgregadoPor", fields: [agregadoPorId], references: [id])

  @@unique([grupoId, usuarioId])
  @@index([grupoId])
  @@index([usuarioId])
  @@map("grupos_ranking_miembros")
}

// ==================== CALENDARIO DE ACTIVIDADES ====================

enum PatronRecurrencia {
  NINGUNO
  SEMANAL
  QUINCENAL
  MENSUAL
  MENSUAL_DIA  // Mismo día del mes (ej: todos los 15)
}

model Actividad {
  id                  Int               @id @default(autoincrement())
  titulo              String            @db.VarChar(200)
  descripcion         String?           @db.Text
  fecha               DateTime          @db.Date
  hora                String?           @db.VarChar(10)   // "09:00"
  horaFin             String?           @map("hora_fin") @db.VarChar(10)  // "12:00"
  color               String            @default("#3B82F6") @db.VarChar(20)  // Hex color
  icono               String            @default("Calendar") @db.VarChar(50)  // Lucide icon name
  esRecurrente        Boolean           @default(false) @map("es_recurrente")
  patronRecurrencia   PatronRecurrencia @default(NINGUNO) @map("patron_recurrencia")
  fechaFinRecurrencia DateTime?         @map("fecha_fin_recurrencia") @db.Date
  diaSemana           Int?              @map("dia_semana")  // 0=Domingo, 1=Lunes, ..., 6=Sábado
  semanaMes           Int?              @map("semana_mes")  // 1-5 para "primer martes del mes", etc.
  actividadPadreId    Int?              @map("actividad_padre_id")
  creadoPorId         Int?              @map("creado_por_id")
  activo              Boolean           @default(true)
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  actividadPadre      Actividad?        @relation("ActividadRecurrencia", fields: [actividadPadreId], references: [id])
  instancias          Actividad[]       @relation("ActividadRecurrencia")
  creadoPor           Usuario?          @relation("ActividadesCreadaPor", fields: [creadoPorId], references: [id])

  @@index([fecha])
  @@map("actividades")
}

// ==================== ESTUDIOS BÍBLICOS ====================

model CursoBiblico {
  id              Int       @id @default(autoincrement())
  nombre          String    @unique @db.VarChar(100) // "La fe de Jesús", etc.
  descripcion     String?   @db.VarChar(255)
  totalLecciones  Int       @default(20) @map("total_lecciones")
  orden           Int       @default(0)
  activo          Boolean   @default(true)
  createdAt       DateTime  @default(now()) @map("created_at")

  estudiantes     EstudianteBiblico[]

  @@map("cursos_biblicos")
}

model EstudianteBiblico {
  id              Int       @id @default(autoincrement())
  nombre          String    @db.VarChar(150)
  fechaNacimiento DateTime? @map("fecha_nacimiento") @db.Date
  estadoCivil     String?   @map("estado_civil") @db.VarChar(30) // Soltero, Casado, Viudo, Divorciado
  telefono        String?   @db.VarChar(20)
  direccion       String?   @db.VarChar(255)
  notas           String?   @db.Text

  // Relación con curso
  cursoId         Int       @map("curso_id")

  // Instructor (usuario que lo registró)
  instructorId    Int       @map("instructor_id")

  // Fecha de bautismo (cuando se bautiza)
  fechaBautismo   DateTime? @map("fecha_bautismo") @db.Date

  activo          Boolean   @default(true)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  curso           CursoBiblico @relation(fields: [cursoId], references: [id])
  instructor      Usuario      @relation("EstudiantesBiblicos", fields: [instructorId], references: [id])
  progreso        ProgresoLeccion[]

  @@index([instructorId])
  @@index([cursoId])
  @@map("estudiantes_biblicos")
}

model ProgresoLeccion {
  id              Int       @id @default(autoincrement())
  estudianteId    Int       @map("estudiante_id")
  leccion         Int       // Número de lección (1-20)
  completada      Boolean   @default(true)
  fechaCompletada DateTime  @default(now()) @map("fecha_completada") @db.Date
  notas           String?   @db.VarChar(255)

  estudiante      EstudianteBiblico @relation(fields: [estudianteId], references: [id], onDelete: Cascade)

  @@unique([estudianteId, leccion])
  @@index([estudianteId])
  @@map("progreso_lecciones")
}
